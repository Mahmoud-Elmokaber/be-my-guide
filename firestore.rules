rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is a volunteer (any type)
    function isVolunteer() {
      let userType = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType;
      return userType == 'volunteer' || userType == 'sign_language_expert';
    }

    // Helper function to check if user needs assistance
    function isAssistanceSeeker() {
      return resource.data.userType == 'deaf' || resource.data.userType == 'blind';
    }

    // Rules for users collection
    match /users/{userId} {
      // Allow users to read and write their own documents
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Allow volunteers to read users (blind or deaf) who have pending requests
      allow get, list: if request.auth != null
                      && isVolunteer()
                      && isAssistanceSeeker()
                      && resource.data.requestStatus == 'pending';

      // Allow volunteers to update requestStatus to 'accepted' or 'completed' only
      allow update: if request.auth != null
                    && isVolunteer()
                    && isAssistanceSeeker()
                    && (request.resource.data.requestStatus in ['accepted', 'completed'])
                    && request.resource.data.keys().hasOnly(['requestStatus', 'volunteerId', 'volunteerName', 'acceptedAt', 'completedAt']);
    }

    // Rules for requests collection
    match /requests/{requestId} {
      // Allow creation if the userId matches the auth uid
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;

      // Allow the user to read/write their own requests
      allow read, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Allow user to update their own request (but not if they are just creating it)
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;

      // Allow volunteers (both types) to read pending requests
      allow read: if request.auth != null
                  && isVolunteer()
                  && resource.data.status == 'pending';

      // Allow volunteers (both types) to update status to accepted/completed
      allow update: if request.auth != null
                    && isVolunteer()
                    && (request.resource.data.status in ['accepted', 'completed']);
    }

  }
}
